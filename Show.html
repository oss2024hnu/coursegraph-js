<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Flow Chart</title>
    <link rel="stylesheet" href="/css/show.css" />
    <link rel="stylesheet" href="/css/search.css">
</head>

<body>
    <h1 id="courseName">학과명 :</h1>
    <button id="backButton">돌아가기</button>
    <input type="file" id="fileInput" />
    <div id="output"></div>
    <div id="searchContainer">
        <input type="text" id="SearchTxt" placeholder="Search...">
        <input type="button" id="SearchBtn" value="Search">
    </div>
    <svg></svg>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/js/show.js"></script>
    <script>
        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const output = document.getElementById('output');
            const courseName = document.getElementById('courseName');

            if (!file) {
                output.innerHTML = 'No file selected';
                courseName.textContent = '학과명 : 파일이 선택되지 않았습니다.';
                return;
            }

            // 파일 이름 출력
            const fileName = file.name;
            courseName.textContent = `학과명 : ${fileName}`;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const result = JSON.parse(e.target.result);
                    let courses;
                    if (fileName.includes('ai.json') || fileName.includes('ce.json') || fileName.includes('me.json')) {
                        courses = result.과목;
                    } else {
                        courses = result;
                    }
                    drawSVGGraph(courses);
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    alert('파일 형식이 맞지 않습니다.');
                }
            };
            reader.readAsText(file);
        });

        function doSearch(text) {
            let isfind = false;
            document.querySelectorAll('text')
                .forEach((element) => {
                    if (doDeleteSpace(element.textContent).includes(doDeleteSpace(text))) {
                        window.find(element.textContent, false, false, false, false, false, false);

                        isfind = true;
                    }
                });
            if (isfind)
                return;
            alert('일치하는 과목을 찾을 수 없습니다.');
        }

        function doDeleteSpace(text) {
            return text.split(' ').join('');
        }

        document.getElementById('SearchBtn').addEventListener('click', function () {
            doSearch(document.getElementById('SearchTxt').value);
        });

        document.getElementById('SearchTxt').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                doSearch(event.target.value);
            }
        });

        document.getElementById('backButton').addEventListener('click', function () {
            window.location.href = '/index.html';
        });
        function drawSVGGraph(courses) {
            const width = 2000;
            const height = 2000;
            const svg = d3.select('svg').attr('width', width).attr('height', height);

            // 학년, 학기별 그룹화
            const groupedCourses = {};
            courses.forEach((course) => {
                if (course.학년 > 4 || (course.학기 !== 1 && course.학기 !== 2)) {
                    return; // 4학년 2학기 이상 또는 유효하지 않은 학기는 제외
                }
                const key = `${course.학년}-${course.학기}`;
                if (!groupedCourses[key]) {
                    groupedCourses[key] = [];
                }
                groupedCourses[key].push(course);
            });

            // 노드 및 링크 초기화
            const nodes = [];
            const links = [];

            let yOffset = 50;
            for (const [semester, courses] of Object.entries(groupedCourses).sort()) {
                let xOffset = 50;

                courses.forEach((course) => {
                    nodes.push({
                        name: course.과목명,
                        학년: course.학년,
                        학기: course.학기,
                        트랙: course.트랙,
                        마이크로디그리: course.마이크로디그리,
                        실습여부: course.실습여부,
                        구분: course.구분,
                        x: xOffset,
                        y: yOffset,
                        prerequisites: course.선수과목 || [],
                    });
                    xOffset += 200; // 가로 간격
                });
                yOffset += 150; // 세로 간격
            }

            const nodeLookup = {};
            nodes.forEach((node) => {
                nodeLookup[node.name] = node;
            });

            // 링크 생성
            nodes.forEach((node) => {
                node.prerequisites.forEach((prerequisite) => {
                    if (nodeLookup[prerequisite]) {
                        links.push({
                            source: nodeLookup[prerequisite],
                            target: node,
                        });
                    }
                });
            });

            // 링크 그리기
            svg
                .selectAll('.link')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('x1', (d) => d.source.x + 50)
                .attr('y1', (d) => d.source.y + 40) // 노드의 아래에서 시작
                .attr('x2', (d) => d.target.x + 50)
                .attr('y2', (d) => d.target.y) // 노드의 위에서 끝
                .attr('marker-end', 'url(#arrow)');

            // 노드 그리기
            const node = svg
                .selectAll('.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', (d) => `translate(${d.x},${d.y})`)
                .on('mouseover', function (event, d) {
                    d3.select(this)
                        .attr('stroke-width', 2)  // 예시: 테두리 두께를 두껍게
                })
                .on('mouseout', function (event, d) {
                    d3.select(this)
                        .attr('stroke-width', 1)  // 원래 테두리 두께로 복구
                });;

            // 노드의 테두리
            node
                .append('rect')
                .attr('width', 185)
                .attr('height', 40)
                .attr('rx', 5)
                .attr('ry', 5)
                .attr('stroke', '#000');

            // 노드의 텍스트
            node
                .append('text')
                .attr('dx', 10)
                .attr('dy', 25)
                .text((d) => d.name);

            // 화살표 정의
            svg
                .append('defs')
                .append('marker')
                .attr('id', 'arrow')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 5)
                .attr('refY', 1)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('class', 'arrowHead');
        }
    </script>
</body>

</html>